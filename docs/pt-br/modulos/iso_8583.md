# iso_8583

## Descrição

Módulo principal para manipulação de mensagens ISO 8583. Este módulo modela uma mensagem ISO 8583 como uma estrutura de dados que contém campos identificados por números inteiros (0-128 ou 0-192 dependendo da versão).

O identificador 0 é reservado para o MTI (Message Type Indicator) da mensagem.

## Funções Exportadas

### Criação de Mensagens

#### `new/0`

Retorna uma mensagem ISO 8583 vazia.

**Retorno:** `iso8583message()`

**Exemplo:**
```erlang
Msg = iso_8583:new().
```

---

### Manipulação de Campos

#### `set/3`

Define o valor de um campo na mensagem e retorna a mensagem atualizada.

**Parâmetros:**
- `FieldId` - ID do campo (inteiro) ou lista de inteiros para subcampos
- `FieldValue` - Valor do campo (string, binary ou mensagem aninhada)
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583message()`

**Exemplos:**
```erlang
% Definir campo simples
Msg1 = iso_8583:set(2, <<"4111111111111111">>, Msg).

% Definir subcampo (campo 127, subcampo 2)
Msg2 = iso_8583:set([127, 2], <<"valor">>, Msg).
```

---

#### `get/2`

Obtém o valor de um campo da mensagem.

**Parâmetros:**
- `FieldId` - ID do campo (inteiro) ou lista de inteiros para subcampos
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583field_value()`

**Lança:** Exceção se o campo não existir

**Exemplos:**
```erlang
% Obter campo simples
Pan = iso_8583:get(2, Msg).

% Obter subcampo
Valor = iso_8583:get([127, 2], Msg).
```

---

#### `get/3`

Obtém o valor de um campo da mensagem com valor padrão caso não exista.

**Parâmetros:**
- `FieldId` - ID do campo
- `Message` - Mensagem ISO 8583
- `Default` - Valor padrão a retornar se campo não existir

**Retorno:** `iso8583field_value()`

**Exemplo:**
```erlang
% Retorna <<"00">> se campo 39 não existir
RespCode = iso_8583:get(39, Msg, <<"00">>).
```

---

#### `has_field/2`

Verifica se um campo existe na mensagem.

**Parâmetros:**
- `FieldId` - ID do campo (inteiro) ou lista para subcampos
- `Message` - Mensagem ISO 8583

**Retorno:** `boolean()`

**Exemplo:**
```erlang
case iso_8583:has_field(55, Msg) of
    true -> processar_emv(Msg);
    false -> processar_normal(Msg)
end.
```

---

#### `remove/2`

Remove um campo da mensagem e retorna a mensagem atualizada.

**Parâmetros:**
- `FieldId` - ID do campo a remover
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583message()`

**Exemplo:**
```erlang
MsgSemCampo = iso_8583:remove(55, Msg).
```

---

#### `get_fields/1`

Retorna uma lista com os IDs de todos os campos presentes na mensagem.

**Parâmetros:**
- `Message` - Mensagem ISO 8583

**Retorno:** `list(integer())` - Lista ordenada de IDs

**Exemplo:**
```erlang
Campos = iso_8583:get_fields(Msg).
% Retorna: [0, 2, 3, 4, 11, 41, 42]
```

---

### Manipulação de MTI

#### `set_mti/2`

Função conveniente para definir o MTI (Message Type Indicator) da mensagem.

**Parâmetros:**
- `Mti` - MTI como string ou binary (4 dígitos)
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583message()`

**Exemplo:**
```erlang
Msg1 = iso_8583:set_mti(<<"0200">>, Msg).
```

---

#### `get_mti/1`

Função conveniente para obter o MTI da mensagem.

**Parâmetros:**
- `Message` - Mensagem ISO 8583

**Retorno:** `string()` ou `binary()`

**Exemplo:**
```erlang
Mti = iso_8583:get_mti(Msg).
% Retorna: <<"0200">>
```

---

### Atributos da Mensagem

#### `set_attribute/3`

Define o valor de um atributo da mensagem.

**Parâmetros:**
- `Key` - Chave do atributo
- `Value` - Valor do atributo
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583message()`

**Exemplo:**
```erlang
% Marcar mensagem como enviada
Msg1 = iso_8583:set_attribute(direction, sent, Msg).
```

---

#### `get_attribute/2`

Obtém o valor de um atributo da mensagem.

**Parâmetros:**
- `Key` - Chave do atributo
- `Message` - Mensagem ISO 8583

**Retorno:** Valor do atributo

**Lança:** `{attribute_not_found, Key}` se atributo não existir

---

#### `get_attribute/3`

Obtém o valor de um atributo com valor padrão.

**Parâmetros:**
- `Key` - Chave do atributo
- `Message` - Mensagem ISO 8583
- `Default` - Valor padrão

**Retorno:** Valor do atributo ou `Default`

**Exemplo:**
```erlang
Direction = iso_8583:get_attribute(direction, Msg, unknown).
```

---

#### `get_attribute_keys/1`

Retorna lista com todas as chaves de atributos.

**Parâmetros:**
- `Message` - Mensagem ISO 8583

**Retorno:** `list(any())`

---

#### `remove_attribute/2`

Remove um atributo da mensagem.

**Parâmetros:**
- `Key` - Chave do atributo
- `Message` - Mensagem ISO 8583

**Retorno:** `iso8583message()`

---

### Validação

#### `is_message/1`

Verifica se um termo é uma mensagem ISO 8583 válida.

**Parâmetros:**
- `Term` - Termo a verificar

**Retorno:** `boolean()`

**Exemplo:**
```erlang
case iso_8583:is_message(Data) of
    true -> processar(Data);
    false -> {error, not_iso8583_message}
end.
```

---

## Tipos de Dados

### `iso8583message()`

Registro que encapsula uma mensagem ISO 8583:
- `attributes` - Lista de atributos da mensagem
- `values` - Dicionário com os valores dos campos

### `iso8583field_value()`

Tipos válidos para valores de campos:
- `binary()` - Valor binário
- `string()` - String UTF-8
- `iso8583message()` - Mensagem aninhada (para campos complexos)

## Notas de Implementação

- Os valores de campos são armazenados internamente como binários ou mensagens
- Strings são automaticamente convertidas para binários UTF-8
- O campo 0 é reservado para o MTI
- Suporta campos aninhados através de listas de IDs (ex: `[127, 2]`)
- Campos são armazenados usando estrutura `dict` do Erlang

## Veja Também

- [iso_8583_fields](../fields/iso_8583_fields.md) - Definições de campos
- [iso_8583_marshaller](../marshallers/iso_8583_marshaller.md) - Serialização de mensagens
- [iso_8583_message_utils](../utils/iso_8583_message_utils.md) - Utilitários para mensagens
