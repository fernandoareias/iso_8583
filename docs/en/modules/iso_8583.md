# iso_8583

## Description

Main module for handling ISO 8583 messages. This module models an ISO 8583 message as a data structure containing fields identified by integers (0-128 or 0-192 depending on version).

Identifier 0 is reserved for the message's MTI (Message Type Indicator).

## Exported Functions

### Message Creation

#### `new/0`

Returns an empty ISO 8583 message.

**Return:** `iso8583message()`

**Example:**
```erlang
Msg = iso_8583:new().
```

---

### Field Manipulation

#### `set/3`

Sets a field value in the message and returns the updated message.

**Parameters:**
- `FieldId` - Field ID (integer) or list of integers for subfields
- `FieldValue` - Field value (string, binary, or nested message)
- `Message` - ISO 8583 message

**Return:** `iso8583message()`

**Examples:**
```erlang
% Set simple field
Msg1 = iso_8583:set(2, <<"4111111111111111">>, Msg).

% Set subfield (field 127, subfield 2)
Msg2 = iso_8583:set([127, 2], <<"value">>, Msg).
```

---

#### `get/2`

Gets a field value from the message.

**Parameters:**
- `FieldId` - Field ID (integer) or list of integers for subfields
- `Message` - ISO 8583 message

**Return:** `iso8583field_value()`

**Throws:** Exception if field does not exist

**Examples:**
```erlang
% Get simple field
Pan = iso_8583:get(2, Msg).

% Get subfield
Value = iso_8583:get([127, 2], Msg).
```

---

#### `get/3`

Gets a field value from the message with a default value if it doesn't exist.

**Parameters:**
- `FieldId` - Field ID
- `Message` - ISO 8583 message
- `Default` - Default value to return if field doesn't exist

**Return:** `iso8583field_value()`

**Example:**
```erlang
% Returns <<"00">> if field 39 doesn't exist
RespCode = iso_8583:get(39, Msg, <<"00">>).
```

---

#### `has_field/2`

Checks if a field exists in the message.

**Parameters:**
- `FieldId` - Field ID (integer) or list for subfields
- `Message` - ISO 8583 message

**Return:** `boolean()`

**Example:**
```erlang
case iso_8583:has_field(55, Msg) of
    true -> process_emv(Msg);
    false -> process_normal(Msg)
end.
```

---

#### `remove/2`

Removes a field from the message and returns the updated message.

**Parameters:**
- `FieldId` - ID of field to remove
- `Message` - ISO 8583 message

**Return:** `iso8583message()`

**Example:**
```erlang
MsgWithoutField = iso_8583:remove(55, Msg).
```

---

#### `get_fields/1`

Returns a list with the IDs of all fields present in the message.

**Parameters:**
- `Message` - ISO 8583 message

**Return:** `list(integer())` - Sorted list of IDs

**Example:**
```erlang
Fields = iso_8583:get_fields(Msg).
% Returns: [0, 2, 3, 4, 11, 41, 42]
```

---

### MTI Manipulation

#### `set_mti/2`

Convenience function to set the message's MTI (Message Type Indicator).

**Parameters:**
- `Mti` - MTI as string or binary (4 digits)
- `Message` - ISO 8583 message

**Return:** `iso8583message()`

**Example:**
```erlang
Msg1 = iso_8583:set_mti(<<"0200">>, Msg).
```

---

#### `get_mti/1`

Convenience function to get the message's MTI.

**Parameters:**
- `Message` - ISO 8583 message

**Return:** `string()` or `binary()`

**Example:**
```erlang
Mti = iso_8583:get_mti(Msg).
% Returns: <<"0200">>
```

---

### Message Attributes

#### `set_attribute/3`

Sets a message attribute value.

**Parameters:**
- `Key` - Attribute key
- `Value` - Attribute value
- `Message` - ISO 8583 message

**Return:** `iso8583message()`

**Example:**
```erlang
% Mark message as sent
Msg1 = iso_8583:set_attribute(direction, sent, Msg).
```

---

#### `get_attribute/2`

Gets a message attribute value.

**Parameters:**
- `Key` - Attribute key
- `Message` - ISO 8583 message

**Return:** Attribute value

**Throws:** `{attribute_not_found, Key}` if attribute doesn't exist

---

#### `get_attribute/3`

Gets an attribute value with a default value.

**Parameters:**
- `Key` - Attribute key
- `Message` - ISO 8583 message
- `Default` - Default value

**Return:** Attribute value or `Default`

**Example:**
```erlang
Direction = iso_8583:get_attribute(direction, Msg, unknown).
```

---

#### `get_attribute_keys/1`

Returns list with all attribute keys.

**Parameters:**
- `Message` - ISO 8583 message

**Return:** `list(any())`

---

#### `remove_attribute/2`

Removes an attribute from the message.

**Parameters:**
- `Key` - Attribute key
- `Message` - ISO 8583 message

**Return:** `iso8583message()`

---

### Validation

#### `is_message/1`

Checks if a term is a valid ISO 8583 message.

**Parameters:**
- `Term` - Term to check

**Return:** `boolean()`

**Example:**
```erlang
case iso_8583:is_message(Data) of
    true -> process(Data);
    false -> {error, not_iso8583_message}
end.
```

---

## Data Types

### `iso8583message()`

Record that encapsulates an ISO 8583 message:
- `attributes` - List of message attributes
- `values` - Dictionary with field values

### `iso8583field_value()`

Valid types for field values:
- `binary()` - Binary value
- `string()` - UTF-8 string
- `iso8583message()` - Nested message (for complex fields)

## Implementation Notes

- Field values are stored internally as binaries or messages
- Strings are automatically converted to UTF-8 binaries
- Field 0 is reserved for the MTI
- Supports nested fields through ID lists (e.g., `[127, 2]`)
- Fields are stored using Erlang's `dict` structure

## See Also

- [iso_8583_fields](../fields/iso_8583_fields.md) - Field definitions
- [iso_8583_marshaller](../marshallers/iso_8583_marshaller.md) - Message serialization
- [iso_8583_message_utils](../utils/iso_8583_message_utils.md) - Message utilities
